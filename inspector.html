<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ThreadJS Inspector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared global stylesheet -->
  <link rel="stylesheet" href="https://2lynk.github.io/stylesheet.css">

  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script src="version.js"></script>
</head>
<body>

<header>
  <div class="header-inner">
    
    <!-- Left: Brand + Lynk shortcut -->
    <div style="display:flex; align-items:center; gap:0.75rem;">
      <a href="../" class="brand">
        <div class="brand-mark">T</div>
        <div class="brand-labels">
          <div class="brand-text-main">ThreadJS</div>
          <div class="brand-text-sub">Minecraft JS scripting</div>
        </div>
      </a>

      <!-- ðŸ”— Back to homepage -->
      <a class="nav-pill" href="https://2lynk.github.io/">Lynk</a>
    </div>

    <!-- Right navigation -->
    <nav class="nav-links">
      <a class="nav-pill" href="index.html">API Reference</a>
      <a class="nav-pill nav-pill--accent" href="inspector.html">Inspector</a>
      <a class="nav-pill" href="example-mods.html">Example Mods</a>
      <a class="nav-pill" href="designer.html">Designer</a>
    </nav>

  </div>
</header>

<div class="version-bar">
  <label for="versionSelectInspector">Version:</label>
  <select id="versionSelectInspector" class="version-select"></select>
  <span id="versionNoteInspector" class="version-note"></span>
</div>

<main>
  <aside id="sidebar">
    <h2>Modules</h2>
    <ul id="tag-list"></ul>
  </aside>

  <section id="content-panel">
    <div id="intro" class="intro"></div>
    <div id="sections"></div>
  </section>
</main>

<script>
/* -----------------------------
   Same inspector logic as before
   ----------------------------- */

const tagListEl = document.getElementById("tag-list");
const sectionsEl = document.getElementById("sections");
const introEl = document.getElementById("intro");
const contentPanel = document.getElementById("content-panel");

const tagLinksByName = {};
const tagLisByName = {};
const sectionEls = [];
let tagsGlobal = [];

function scrollToSectionId(id) {
  const el = document.getElementById(id);
  if (!el || !contentPanel) return;
  const contentRect = contentPanel.getBoundingClientRect();
  const elRect = el.getBoundingClientRect();
  const offset = elRect.top - contentRect.top + contentPanel.scrollTop - 10;
  contentPanel.scrollTo({ top: offset, behavior: "smooth" });
}

function setActiveTag(tagName) {
  Object.values(tagLinksByName).forEach((l) => l.classList.remove("active"));
  Object.values(tagLisByName).forEach((li) => li.classList.remove("active-tag"));

  const l = tagLinksByName[tagName];
  const li = tagLisByName[tagName];

  if (l) l.classList.add("active");
  if (li) li.classList.add("active-tag");
}

function makeDomId(tag, summary) {
  const safe = String(summary || "")
    .toLowerCase()
    .replace(/[^\w]+/g, "-")
    .replace(/^-+|-+$/g, "");
  return "func-" + tag.toLowerCase() + "-" + safe;
}

function showLoading(msg) {
  sectionsEl.innerHTML =
    '<div class="loading-msg">' + (msg || "Loadingâ€¦") + "</div>";
}

function showError(msg) {
  sectionsEl.innerHTML =
    '<div class="error-msg">' + (msg || "Error loading spec.") + "</div>";
}

function renderOpenApiFromText(yamlText) {
  let spec;
  try {
    spec = jsyaml.load(yamlText);
  } catch (e) {
    introEl.innerHTML = "";
    showError("Invalid YAML: " + e);
    return;
  }

  if (spec.info && spec.info.description) {
    introEl.innerHTML = marked.parse(spec.info.description);
  } else {
    introEl.textContent = "Inspector view for ThreadJS API.";
  }

  const tags = (spec.tags || []).map((t) => t.name);
  tagsGlobal = tags;

  const operationsByTag = {};
  const paths = spec.paths || {};

  for (const p in paths) {
    const op = paths[p];
    if (!op || !op.tags) continue;

    const summary = op.summary || p;
    const description = op.description || "";
    const samples = op["x-codeSamples"] || [];

    op.tags.forEach((tag) => {
      if (!operationsByTag[tag]) operationsByTag[tag] = [];
      operationsByTag[tag].push({
        path: p,
        tag,
        summary,
        description,
        samples,
      });
    });
  }

  // assign DOM ids
  Object.keys(operationsByTag).forEach((tag) => {
    operationsByTag[tag].forEach((fn) => {
      fn.domId = makeDomId(tag, fn.summary);
    });
  });

  // Sidebar
  tagListEl.innerHTML = "";
  Object.keys(tagLinksByName).forEach((k) => delete tagLinksByName[k]);
  Object.keys(tagLisByName).forEach((k) => delete tagLisByName[k]);

  tags.forEach((tag, idx) => {
    const funcs = operationsByTag[tag] || [];

    const li = document.createElement("li");
    const a = document.createElement("a");
    a.className = "tag-link" + (idx === 0 ? " active" : "");
    a.textContent = tag;
    a.href = "javascript:void(0)";

    tagLinksByName[tag] = a;
    tagLisByName[tag] = li;

    a.onclick = () => {
      scrollToSectionId("tag-" + tag);
      setActiveTag(tag);
    };

    li.appendChild(a);

    if (funcs.length > 0) {
      const funcList = document.createElement("ul");
      funcList.className = "tag-func-list";

      funcs.forEach((fn) => {
        const li2 = document.createElement("li");
        const b = document.createElement("button");
        b.className = "tag-func-link";
        b.type = "button";
        b.textContent = fn.summary;
        b.onclick = () => {
          scrollToSectionId(fn.domId);
          setActiveTag(tag);
        };

        li2.appendChild(b);
        funcList.appendChild(li2);
      });

      li.appendChild(funcList);
    }

    tagListEl.appendChild(li);
    if (idx === 0) li.classList.add("active-tag");
  });

  // Main content
  sectionsEl.innerHTML = "";
  sectionEls.length = 0;

  tags.forEach((tag) => {
    const funcs = operationsByTag[tag] || [];
    if (funcs.length === 0) return;

    const sec = document.createElement("section");
    sec.className = "tag-section";
    sec.id = "tag-" + tag;
    sec.dataset.tag = tag;

    const h2 = document.createElement("h2");
    h2.textContent = tag;
    sec.appendChild(h2);

    funcs.forEach((fn) => {
      const card = document.createElement("article");
      card.className = "function-card";
      card.id = fn.domId;

      const head = document.createElement("div");
      head.className = "function-header";

      const name = document.createElement("div");
      name.className = "function-name";
      name.textContent = fn.summary;

      const tagLabel = document.createElement("div");
      tagLabel.className = "function-tag-label";
      tagLabel.textContent = tag;

      head.appendChild(name);
      head.appendChild(tagLabel);
      card.appendChild(head);

      const body = document.createElement("div");
      body.className = "function-body";

      const desc = document.createElement("div");
      desc.className = "func-description";
      desc.innerHTML = fn.description
        ? marked.parse(fn.description)
        : "No description provided.";

      const samples = document.createElement("div");
      samples.className = "func-samples";

      if (fn.samples && fn.samples.length > 0) {
        const t = document.createElement("div");
        t.className = "func-samples-title";
        t.textContent = "Examples";
        samples.appendChild(t);

        fn.samples.forEach((s) => {
          const block = document.createElement("div");
          block.className = "sample-block";

          const lab = document.createElement("div");
          lab.className = "sample-label";
          lab.textContent =
            (s.label || s.lang || "Example") +
            (s.lang ? " â€” " + s.lang : "");
          block.appendChild(lab);

          const pre = document.createElement("pre");
          const code = document.createElement("code");
          code.textContent = s.source || "";
          pre.appendChild(code);
          block.appendChild(pre);

          samples.appendChild(block);
        });
      }

      body.appendChild(desc);
      body.appendChild(samples);
      card.appendChild(body);
      sec.appendChild(card);
    });

    sectionsEl.appendChild(sec);
    sectionEls.push(sec);
  });

  if (!sectionsEl.innerHTML.trim()) {
    showError("No functions found in this version.");
  }

  if (tags.length > 0) {
    scrollToSectionId("tag-" + tags[0]);
    setActiveTag(tags[0]);
  }

  contentPanel.addEventListener("scroll", () => {
    if (sectionEls.length === 0) return;

    const rect = contentPanel.getBoundingClientRect();
    let best = tags[0];
    let bestDelta = Infinity;

    sectionEls.forEach((sec) => {
      const r = sec.getBoundingClientRect();
      const delta = r.top - rect.top;
      if (delta <= 40 && Math.abs(delta) < bestDelta) {
        bestDelta = Math.abs(delta);
        best = sec.dataset.tag;
      }
    });

    setActiveTag(best);
  });
}

function loadYamlAndRender(path) {
  showLoading("Loading spec: " + path);
  fetch(path)
    .then((r) => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.text();
    })
    .then(renderOpenApiFromText)
    .catch((e) => {
      introEl.innerHTML = "";
      showError("Failed: " + e);
    });
}

document.addEventListener("DOMContentLoaded", () => {
  ThreadJsVersion.initSelector({
    selectId: "versionSelectInspector",
    noteId: "versionNoteInspector",
    onReady(entry) {
      loadYamlAndRender(entry.yamlPath);
    },
    onChange(entry) {
      loadYamlAndRender(entry.yamlPath);
    },
  });
});
</script>

</body>
</html>
